<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Adatbázis Címkekezelő</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="jsQR.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f0f0f0;
    }
    nav {
      margin-bottom: 20px;
      background-color: #007BFF;
      padding: 10px;
      border-radius: 5px;
    }
    .nav-link {
      margin-right: 15px;
      cursor: pointer;
      text-decoration: underline;
      color: white;
    }
    .nav-link:hover {
      color: #f0f0f0;
    }
    .lap-content {
      display: none;
    }
    .active {
      display: block;
    }
    .version-info {
      margin-bottom: 20px;
      background-color: #e0e0e0;
      padding: 10px;
      border-radius: 5px;
    }
    #version-history-popup {
      display: none;
      background-color: #fff;
      padding: 20px;
      border: 1px solid #ccc;
      max-width: 500px;
      margin: 20px auto;
    }
    #version-history-popup h3 {
      margin-top: 0;
    }
    #version-history-popup ul {
      list-style-type: none;
      padding-left: 0;
    }
    #version-history-popup li {
      margin-bottom: 10px;
    }
    .cimke {
      width: 60mm;
      height: 30mm;
      padding: 3mm;
      border: 1px solid black;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-family: Arial, sans-serif;
      font-size: 10px;
      background-color: #ffffff;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      border-radius: 5px;
    }
    .qr-container {
      width: 25mm;
      height: 25mm;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-left: -3mm;
      background-color: #f8f9fa;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .szoveg-container {
      max-width: 60%;
      text-align: left;
      line-height: 1.5;
      padding-left: 5mm;
      padding-right: 5mm;
      color: #333;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .szam {
      font-weight: bold;
      font-size: 14px;
      margin-bottom: 5px;
    }
    .input-group {
      margin-bottom: 10px;
    }
    .help-text {
      font-size: 12px;
      color: #007BFF;
    }
    h1 {
      color: #007BFF;
    }
    button {
      background-color: #007BFF;
      color: white;
      border: none;
      padding: 10px 15px;
      cursor: pointer;
      border-radius: 5px;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #0056b3;
    }
    input[type="text"], input[type="password"], select {
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
      width: 100%;
      box-sizing: border-box;
    }
    #qr-reader {
      width: 100%;
      max-width: 500px;
      margin: 10px 0;
    }
    #qr-reader video {
      width: 100%;
      max-width: 500px;
    }
    #qr-reader canvas {
      display: none;
    }
    .error-message {
      color: red;
      font-size: 12px;
      margin-top: 5px;
    }
    #foglalas-tablazat, #settings-table {
      overflow-x: auto;
      margin-top: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      border: 1px solid #ccc;
    }
    th, td {
      padding: 5px;
      border: 1px solid #ccc;
    }
    th {
      background-color: #007BFF;
      color: white;
    }
  </style>
</head>
<body>

  <h1>AI Adatbázis Címkekezelő</h1>
  
  <div class="version-info">
    <p>Verzió: <span id="version-number">2.5.0</span></p>
    <button onclick="showVersionHistory()">Verzió Történet</button>
  </div>
  <div id="version-history-popup">
    <h3>Verzió Történet</h3>
    <ul>
      <li><strong>2.5.0</strong> – Foglalások gépekhez rendelése QR-olvasáskor, gépek kiválasztása lenyíló menüből.</li>
      <li><strong>2.4.0</strong> – Táblázatos Foglalási Lista, admin jelszavas törlés (teljes és soronkénti), Beállítási oldal gépek kezelésére (felvétel, törlés, szerkesztés, áthelyezés), MI PAD képernyőhöz igazítás.</li>
      <li><strong>2.3.1</strong> – QR olvasás finomhangolása jsQR-rel, helyi jsQR.min.js használata, közepes felbontás (640x480).</li>
      <li><strong>2.3</strong> – Javítva a html5-qrcode betöltési hibája, jobb hibakezelés a kamera indításához.</li>
      <li><strong>2.2</strong> – Kamera indítási hibák javítása, jobb hibakezelés a QR olvasáshoz.</li>
      <li><strong>2.1</strong> – Telefon kamerás QR olvasás, foglalások dátum szerint mentése, dizájn finomhangolás.</li>
      <li><strong>2.0</strong> – Új lapok hozzáadása (QR kód generálás, Foglalási Lista), dizájn színesítése, verzió kezelés.</li>
      <li><strong>1.1</strong> – QR kódok testreszabása, szövegkezelés fejlesztése.</li>
      <li><strong>1.0</strong> – Alap QR kód generálás.</li>
    </ul>
    <button onclick="closeVersionHistory()">Bezárás</button>
  </div>

  <nav>
    <span class="nav-link" onclick="showLap(1)">QR Kód Generálás</span>
    <span class="nav-link" onclick="showLap(2)">QR Kód Olvasás (Foglalás)</span>
    <span class="nav-link" onclick="showLap(3)">Foglalási Lista</span>
    <span class="nav-link" onclick="showLap(4)">Segítség</span>
    <span class="nav-link" onclick="showLap(5)">Beállítások</span>
  </nav>

  <div id="lap1" class="lap-content active">
    <h2>QR Kód Generálás</h2>
    <label for="text-input">Szöveg (Anyagszám + leírás):</label>
    <input type="text" id="text-input" placeholder="Pl.: 7004567 Leírás" maxlength="60">
    <div id="char-count" style="margin-top:10px;">Még <span id="remaining-chars">60</span> karakter maradt.</div>
    <button onclick="generateQRCode()">QR Kód Generálás</button>
    <div id="qr-error" class="error-message"></div>
    <br><br>
    <div class="cimke">
      <div class="qr-container">
        <canvas id="qrcode"></canvas>
      </div>
      <div class="szoveg-container">
        <div id="szam" class="szam"></div>
        <div id="szoveg" class="szoveg"></div>
      </div>
    </div>
  </div>

  <div id="lap2" class="lap-content">
    <h2>QR Kód Olvasás (Foglalás)</h2>
    <div id="qr-reader">
      <video id="video" style="width: 100%; max-width: 500px;"></video>
      <canvas id="canvas"></canvas>
    </div>
    <div id="qr-reader-result" class="help-text"></div>
    <label for="select-machine">Gép kiválasztása:</label>
    <select id="select-machine" style="margin: 10px 0; width: 100%; max-width: 500px;">
      <!-- Gépek dinamikusan töltődnek -->
    </select>
    <button id="start-camera-btn" onclick="startQRReader()">Kamera Indítása</button>
    <button id="stop-camera-btn" onclick="stopQRReader()" style="display: none;">Kamera Leállítása</button>
    <div id="qr-reader-error" class="error-message"></div>
  </div>

  <div id="lap3" class="lap-content">
    <h2>Foglalási Lista</h2>
    <button id="delete-all-btn-top" style="background-color: #FF0000; color: white;">Törlés összes rekord</button>
    <div id="foglalas-tablazat" style="overflow-x: auto; margin-top: 10px;">
      <table style="width: 100%; border-collapse: collapse; border: 1px solid #ccc;">
        <thead>
          <tr style="background-color: #007BFF; color: white;">
            <th style="padding: 5px; width: 50px;">Sorszám</th>
            <th style="padding: 5px; width: 100px;">Anyagszám</th>
            <th style="padding: 5px; width: 150px;">Megnevezés</th>
            <th style="padding: 5px; width: 80px;">Raktár</th>
            <th style="padding: 5px; width: 80px;">Művelet</th>
            <th style="padding: 5px; width: 80px;">Mennyiség</th>
            <th style="padding: 5px; width: 150px;">Kontírozva</th>
            <th style="padding: 5px; width: 80px;">SAP kód</th>
            <th style="padding: 5px; width: 150px;">Belső megrendelési szám</th>
            <th style="padding: 5px; width: 150px;">Gép neve</th>
            <th style="padding: 5px; width: 30px;"></th>
          </tr>
        </thead>
        <tbody id="foglalas-body"></tbody>
      </table>
    </div>
    <button id="delete-all-btn-bottom" style="background-color: #FF0000; color: white; margin-top: 10px;">Törlés összes rekord</button>
  </div>

  <div id="lap4" class="lap-content">
    <h2>Segítség</h2>
    <p>A program különböző funkciók használatára szolgál:</p>
    <ul>
      <li><b>QR Kód Generálás:</b> Kódot generál az anyagszám és leírás alapján.</li>
      <li><b>QR Kód Olvasás (Foglalás):</b> A telefon kamerájával olvassa be a QR kódot, és rögzíti a foglalást egy kiválasztott gépre.</li>
      <li><b>Foglalási Lista:</b> Megjeleníti a foglalások listáját dátummal és gépek adataival.</li>
      <li><b>Beállítások:</b> Gépek kezelésére szolgál (felvétel, törlés, szerkesztés, áthelyezés).</li>
    </ul>
  </div>

  <div id="lap5" class="lap-content" style="display: none;">
    <h2>Beállítások</h2>
    <button id="add-machine-btn" style="background-color: #007BFF; color: white; padding: 10px 15px; border: none; border-radius: 5px;">Új gép hozzáadása</button>
    <div id="settings-table" style="overflow-x: auto; margin-top: 10px;">
      <table style="width: 100%; border-collapse: collapse; border: 1px solid #ccc;">
        <thead>
          <tr style="background-color: #007BFF; color: white;">
            <th style="padding: 5px; width: 50px;">Sorszám</th>
            <th style="padding: 5px; width: 200px;">Gép neve</th>
            <th style="padding: 5px; width: 150px;">Terület</th>
            <th style="padding: 5px; width: 150px;">Belső megrendelési szám</th>
            <th style="padding: 5px; width: 100px;">Költséghely</th>
            <th style="padding: 5px; width: 100px;">Műveletek</th>
          </tr>
        </thead>
        <tbody id="machine-body"></tbody>
      </table>
    </div>
  </div>

  <div id="delete-password-popup" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #fff; padding: 20px; border: 1px solid #ccc; max-width: 300px; text-align: center;">
    <h3>Kérlek, add meg az admin jelszót a törléshez!</h3>
    <input type="password" id="delete-password" style="padding: 5px; width: 200px; margin-bottom: 10px;">
    <div id="delete-password-error" style="color: red; font-size: 12px; margin-top: 5px;"></div>
    <button onclick="checkPassword()" style="background-color: #007BFF; color: white; padding: 10px; border: none; border-radius: 5px;">OK</button>
    <button onclick="document.getElementById('delete-password-popup').style.display='none'; document.getElementById('delete-password').value=''; document.getElementById('delete-password-error').textContent='';" style="background-color: #ccc; color: black; padding: 10px; border: none; border-radius: 5px; margin-left: 10px;">Mégse</button>
  </div>

  <div id="settings-password-popup" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #fff; padding: 20px; border: 1px solid #ccc; max-width: 300px; text-align: center;">
    <h3>Kérlek, add meg az admin jelszót a Beállítási oldalhoz!</h3>
    <input type="password" id="settings-password" style="padding: 5px; width: 200px; margin-bottom: 10px;">
    <div id="settings-password-error" style="color: red; font-size: 12px; margin-top: 5px;"></div>
    <button onclick="checkSettingsPassword()" style="background-color: #007BFF; color: white; padding: 10px; border: none; border-radius: 5px;">OK</button>
    <button onclick="document.getElementById('settings-password-popup').style.display='none'; document.getElementById('settings-password').value=''; document.getElementById('settings-password-error').textContent='';" style="background-color: #ccc; color: black; padding: 10px; border: none; border-radius: 5px; margin-left: 10px;">Mégse</button>
  </div>

  <div id="edit-machine-popup" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #fff; padding: 20px; border: 1px solid #ccc; max-width: 400px; text-align: center;">
    <h3>Gép szerkesztése</h3>
    <input type="text" id="edit-machine-name" style="padding: 5px; width: 300px; margin-bottom: 10px;" placeholder="Gép neve">
    <select id="edit-machine-terulet" style="padding: 5px; width: 300px; margin-bottom: 10px;">
      <option value="MFC-terület">MFC-terület</option>
      <option value="MFS-terület">MFS-terület</option>
      <option value="MFH-terület">MFH-terület</option>
      <option value="M2B-terület">M2B-terület</option>
    </select>
    <input type="text" id="edit-machine-belsoszam" style="padding: 5px; width: 300px; margin-bottom: 10px;" placeholder="Belső megrendelési szám">
    <input type="text" id="edit-machine-koltseghely" style="padding: 5px; width: 300px; margin-bottom: 10px;" placeholder="Költséghely">
    <button onclick="saveMachineEdit()" style="background-color: #007BFF; color: white; padding: 10px; border: none; border-radius: 5px;">Mentés</button>
    <button onclick="document.getElementById('edit-machine-popup').style.display='none'; document.getElementById('edit-machine-name').value=''; document.getElementById('edit-machine-belsoszam').value=''; document.getElementById('edit-machine-koltseghely').value='';" style="background-color: #ccc; color: black; padding: 10px; border: none; border-radius: 5px; margin-left: 10px;">Mégse</button>
  </div>

  <script>
    // Lapváltás
    function showLap(lap) {
      var lapok = document.querySelectorAll('.lap-content');
      lapok.forEach(function(lapContent) {
        lapContent.classList.remove('active');
      });
      document.getElementById('lap' + lap).classList.add('active');
      if (lap === 2) updateMachineDropdown(); // Gépek frissítése QR olvasás lapon
    }

    // Verziótörténet megjelenítése és bezárása
    function showVersionHistory() {
      document.getElementById("version-history-popup").style.display = "block";
    }
    function closeVersionHistory() {
      document.getElementById("version-history-popup").style.display = "none";
    }

    // Karakter számláló a szövegbevitelnél
    document.getElementById("text-input").addEventListener("input", function() {
      var maxChars = 60;
      var remaining = maxChars - this.value.length;
      document.getElementById("remaining-chars").textContent = remaining;
    });

    // QR kód generálása fix mérettel
    function generateQRCode() {
      var text = document.getElementById("text-input").value.trim();
      if (!text) {
        document.getElementById("qr-error").textContent = "Kérlek, írj be valamilyen szöveget!";
        return;
      }
      var parts = text.split(" ");
      var numberPart = parts.shift() || "";
      var textPart = parts.join(" ") || "";
      document.getElementById("szam").textContent = numberPart;
      document.getElementById("szoveg").textContent = textPart;
      QRCode.toCanvas(document.getElementById("qrcode"), text, { width: 95 }, function(error) {
        if (error) {
          document.getElementById("qr-error").textContent = "Hiba történt a QR-kód generálása közben: " + error.message;
          console.error("QR Kód generálási hiba:", error);
        } else {
          document.getElementById("qr-error").textContent = "";
          console.log("QR kód generálva!");
        }
      });
    }

    // QR kód olvasás jsQR-rel
    let videoStream = null;
    let isScanning = false;

    function startQRReader() {
      if (isScanning) {
        document.getElementById("qr-reader-error").textContent = "A kamera már fut. Előbb állítsd le!";
        return;
      }

      const video = document.getElementById("video");
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");

      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        document.getElementById("qr-reader-error").textContent = "Sajnos a böngésződ nem támogatja a kamera hozzáférést.";
        return;
      }

      navigator.mediaDevices.getUserMedia({ 
        video: { 
          facingMode: "environment",
          width: { ideal: 640 }, 
          height: { ideal: 480 }
        } 
      })
        .then(stream => {
          videoStream = stream;
          video.srcObject = stream;
          video.play();
          isScanning = true;
          document.getElementById("start-camera-btn").style.display = "none";
          document.getElementById("stop-camera-btn").style.display = "inline";
          document.getElementById("qr-reader-error").textContent = "";

          video.onloadedmetadata = () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            console.log("Videó mérete: " + video.videoWidth + "x" + video.videoHeight);
            scanQRCode(video, canvas, ctx);
          };
        })
        .catch(err => {
          document.getElementById("qr-reader-error").textContent = "Kamera indítási hiba: " + err.message;
          console.error("Kamera indítási hiba:", err);
        });
    }

    function scanQRCode(video, canvas, ctx) {
      if (!isScanning) return;

      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      console.log("Képkocka feldolgozása: " + canvas.width + "x" + canvas.height);
      const code = jsQR(imageData.data, imageData.width, imageData.height, {
        inversionAttempts: "dontInvert"
      });

      if (code) {
        console.log("QR kód megtalálva:", code.data);
        document.getElementById("qr-reader-result").textContent = "QR Kód olvasva: " + code.data;
        processFoglalas(code.data);
        stopQRReader();
      } else {
        console.log("Nincs QR kód a képen");
        document.getElementById("qr-reader-result").textContent = "QR kód keresése...";
        requestAnimationFrame(() => scanQRCode(video, canvas, ctx));
      }
    }

    function stopQRReader() {
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
        isScanning = false;
        document.getElementById("qr-reader-result").textContent = "Kamera leállítva.";
        document.getElementById("qr-reader-error").textContent = "";
        document.getElementById("start-camera-btn").style.display = "inline";
        document.getElementById("stop-camera-btn").style.display = "none";
      }
    }

    // Gépek dropdown frissítése
    function updateMachineDropdown() {
      const select = document.getElementById("select-machine");
      select.innerHTML = "";
      let allMachines = [];
      for (let terulet in gepek) {
        gepek[terulet].forEach(gep => {
          const gepAdatok = gepekAdatok[gep] || {};
          allMachines.push({ nev: gep, terulet: terulet, belsoMegrendelesiSzam: gepAdatok.belsoMegrendelesiSzam || "", koltseghely: gepAdatok.koltseghely || "" });
        });
      }
      allMachines.forEach(machine => {
        const option = document.createElement("option");
        option.value = machine.nev;
        option.text = `${machine.nev} (${machine.terulet})`;
        select.appendChild(option);
      });
    }

    // Foglalások tárolása és listázása dátummal
    let foglalasok = JSON.parse(localStorage.getItem('foglalasok')) || [];
    function saveFoglalas(cimkeInput) {
      const parts = cimkeInput.split(" ");
      const anyagszam = parts.shift() || "";
      const megnevezes = parts.join(" ") || "";
      const selectedMachine = document.getElementById("select-machine").value;
      const machineData = gepekAdatok[selectedMachine] || {};
      const currentDate = new Date().toLocaleString('hu-HU', {
        year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
      });
      const foglalas = {
        cimke: cimkeInput,
        anyagszam: anyagszam,
        megnevezes: megnevezes,
        raktar: "0060",
        muvelet: "Kivét",
        mennyiseg: 1,
        kontirozva: selectedMachine,
        sapKod: "261",
        belsoMegrendelesiSzam: machineData.belsoMegrendelesiSzam || "",
        gepNev: selectedMachine,
        datum: currentDate
      };
      foglalasok.push(foglalas);
      localStorage.setItem('foglalasok', JSON.stringify(foglalasok));
      updateFoglalasLista();
    }

    function processFoglalas(cimkeInput) {
      if (cimkeInput) {
        document.getElementById("qr-reader-result").textContent = "Foglalás sikeresen végrehajtva: " + cimkeInput;
        saveFoglalas(cimkeInput);
      } else {
        document.getElementById("qr-reader-error").textContent = "Hiba: Érvénytelen QR kód!";
      }
    }

    function updateFoglalasLista() {
      const tbody = document.getElementById("foglalas-body");
      if (foglalasok.length > 0) {
        tbody.innerHTML = foglalasok.map((item, index) => `
          <tr>
            <td style="padding: 5px; border: 1px solid #ccc;">${index + 1}</td>
            <td style="padding: 5px; border: 1px solid #ccc;">${item.anyagszam}</td>
            <td style="padding: 5px; border: 1px solid #ccc;">${item.megnevezes}</td>
            <td style="padding: 5px; border: 1px solid #ccc;">${item.raktar}</td>
            <td style="padding: 5px; border: 1px solid #ccc;">${item.muvelet}</td>
            <td style="padding: 5px; border: 1px solid #ccc;">${item.mennyiseg}</td>
            <td style="padding: 5px; border: 1px solid #ccc;">${item.kontirozva}</td>
            <td style="padding: 5px; border: 1px solid #ccc;">${item.sapKod}</td>
            <td style="padding: 5px; border: 1px solid #ccc;">${item.belsoMegrendelesiSzam}</td>
            <td style="padding: 5px; border: 1px solid #ccc;">${item.gepNev}</td>
            <td style="padding: 5px; border: 1px solid #ccc;">
              <button onclick="showDeletePopup(${index}, false)" style="background-color: #FF0000; color: white; width: 30px; height: 30px; border: none; border-radius: 5px;">T</button>
            </td>
          </tr>
        `).join("");
      } else {
        tbody.innerHTML = "<tr><td colspan='11' style='padding: 10px; border: 1px solid #ccc;'>Nincs foglalás.</td></tr>";
      }
    }

    // Törlési popup logika
    let deleteIndex = null;
    let isAllDelete = false;

    function showDeletePopup(index, isAll) {
      deleteIndex = index;
      isAllDelete = isAll;
      document.getElementById("delete-password-popup").style.display = "block";
    }

    function checkPassword() {
      const password = document.getElementById("delete-password").value;
      if (password === "admin") {
        document.getElementById("delete-password-popup").style.display = "none";
        showConfirmDelete();
      } else {
        document.getElementById("delete-password-error").textContent = "Helytelen jelszó, próbáld újra!";
      }
    }

    function showConfirmDelete() {
      let message = isAllDelete ? "Biztosan törölni szeretnéd az összes rekordot?" : `Biztosan törölni szeretnéd a ${deleteIndex + 1}. rekordot?`;
      if (confirm(message)) {
        if (isAllDelete) {
          foglalasok = [];
        } else {
          foglalasok.splice(deleteIndex, 1);
        }
        localStorage.setItem('foglalasok', JSON.stringify(foglalasok));
        updateFoglalasLista();
        alert("A rekordok törölve");
        showLap(1);
      }
      document.getElementById("delete-password-popup").style.display = "none";
      document.getElementById("delete-password").value = "";
      document.getElementById("delete-password-error").textContent = "";
    }

    // Gépek tárolása és kezelése
    let gepek = JSON.parse(localStorage.getItem('gepek')) || {
      "MFC-terület": [
        "Behringer 1", "Behringer 2", "Behringer 3", "Behringer 4", "Behringer 5",
        "BW 1", "BW 2",
        "DMG 1", "DMG 2", "DMG 3", "DMG 4", "DMG 5", "DMG 6", "DMG CTX",
        "Ferrari 1",
        "Forgácsprés 1", "Forgácsprés 2",
        "G-mill 1", "G-mill 2", "G-mill 3", "G-mill 4", "G-mill 5", "G-mill 6", "G-mill 7", "G-mill 8", "G-mill 9", "G-mill 10",
        "G-mill 11", "G-mill 12", "G-mill 13", "G-mill 14", "G-mill 15", "G-mill 16", "G-mill 17", "G-mill 18", "G-mill 19", "G-mill 20",
        "G-mill 21", "G-mill 22",
        "HEC 1", "HEC 2",
        "Heller 1", "Heller 2", "Heller 3", "Heller 4", "Heller 5",
        "Kaltenbach 1",
        "Koptató 1", "Koptató 2",
        "Központfúró 1", "Központfúró 2", "Központfúró 3",
        "LX 1", "LX 2", "LX 3", "LX 4", "LX 5", "LX 6", "LX 7", "LX 8", "LX 9", "LX 10",
        "LX 11", "LX 12", "LX 13", "LX 14", "LX 15",
        "MCU 1",
        "Stahl",
        "SX 1", "SX 2", "SX 3", "SX 4", "SX 5", "SX 6", "SX 7", "SX 8", "SX 9", "SX 10",
        "SX 11", "SX 12", "SX 13", "SX 14", "SX 15", "SX 16",
        "Szalagvágó 1", "Szalagvágó 2",
        "TM 13", "TM 14", "TM 15", "TM 16", "TM 17", "TM 18", "TM 19", "TM 20", "TM 21", "TM 22",
        "TMg 1", "TMg 2", "TMg 3", "TMg 4", "TMg 5", "TMg 6", "TMg 7", "TMg 8", "TMg 9", "TMg 10",
        "TMg 11", "TMg 12", "TMg 13", "TMg 14", "TMg 15", "TMg 16", "TMg 17", "TMg 18", "TMg 19", "TMg 20",
        "TMg 21", "TMg 22"
      ],
      "MFS-terület": ["Union 1"],
      "MFH-terület": ["Blohm 30/299"],
      "M2B-terület": ["Böhringer DUS 001/175"]
    };
    let gepekAdatok = JSON.parse(localStorage.getItem('gepekAdatok')) || {
      "DMG 1": { belsoMegrendelesiSzam: "U00980000101", koltseghely: "15009126" },
      "Behringer 1": { belsoMegrendelesiSzam: "", koltseghely: "15009126" },
      "G-mill 5": { belsoMegrendelesiSzam: "U00980000073", koltseghely: "15009126" },
      "Union 1": { belsoMegrendelesiSzam: "935118", koltseghely: "15009115" },
      "Blohm 30/299": { belsoMegrendelesiSzam: "U941030_299", koltseghely: "15009450" },
      "Böhringer DUS 001/175": { belsoMegrendelesiSzam: "", koltseghely: "15009200" }
    };

    function saveGepek() {
      localStorage.setItem('gepek', JSON.stringify(gepek));
      localStorage.setItem('gepekAdatok', JSON.stringify(gepekAdatok));
      updateMachineLista();
      updateMachineDropdown();
    }

    function updateMachineLista() {
      const tbody = document.getElementById("machine-body");
      let allMachines = [];
      for (let terulet in gepek) {
        gepek[terulet].forEach(gep => allMachines.push({ nev: gep, terulet: terulet, ...gepekAdatok[gep] }));
      }
      if (allMachines.length > 0) {
        tbody.innerHTML = allMachines.map((item, index) => `
          <tr>
            <td style="padding: 5px; border: 1px solid #ccc;">${index + 1}</td>
            <td style="padding: 5px; border: 1px solid #ccc;">${item.nev}</td>
            <td style="padding: 5px; border: 1px solid #ccc;">${item.terulet}</td>
            <td style="padding: 5px; border: 1px solid #ccc;">${item.belsoMegrendelesiSzam || ""}</td>
            <td style="padding: 5px; border: 1px solid #ccc;">${item.koltseghely || ""}</td>
            <td style="padding: 5px; border: 1px solid #ccc;">
              <button onclick="showEditPopup(${index})" style="background-color: #007BFF; color: white; padding: 5px; border: none; border-radius: 5px; margin-right: 5px;">Szerkesztés</button>
              <button onclick="showDeletePopup(${index}, true)" style="background-color: #FF0000; color: white; padding: 5px; border: none; border-radius: 5px;">Törlés</button>
            </td>
          </tr>
        `).join("");
      } else {
        tbody.innerHTML = "<tr><td colspan='6' style='padding: 10px; border: 1px solid #ccc;'>Nincs gép.</td></tr>";
      }
    }

    // Beállítási oldal jelszavas hozzáférés
    document.getElementById("lap5").style.display = "none";
    document.querySelectorAll(".nav-link")[4].addEventListener("click", () => {
      document.getElementById("settings-password-popup").style.display = "block";
    });

    function checkSettingsPassword() {
      const password = document.getElementById("settings-password").value;
      if (password === "admin") {
        document.getElementById("settings-password-popup").style.display = "none";
        document.getElementById("lap5").style.display = "block";
        showLap(5);
      } else {
        document.getElementById("settings-password-error").textContent = "Helytelen jelszó, próbáld újra!";
      }
    }

    function showEditPopup(index) {
      const allMachines = [];
      for (let terulet in gepek) {
        gepek[terulet].forEach(gep => allMachines.push({ nev: gep, terulet: terulet, ...gepekAdatok[gep] }));
      }
      const machine = allMachines[index];
      document.getElementById("edit-machine-name").value = machine.nev;
      document.getElementById("edit-machine-terulet").value = machine.terulet;
      document.getElementById("edit-machine-belsoszam").value = machine.belsoMegrendelesiSzam || "";
      document.getElementById("edit-machine-koltseghely").value = machine.koltseghely || "";
      document.getElementById("edit-machine-popup").style.display = "block";
    }

    function saveMachineEdit() {
      const allMachines = [];
      for (let terulet in gepek) {
        gepek[terulet].forEach(gep => allMachines.push({ nev: gep, terulet: terulet, ...gepekAdatok[gep] }));
      }
      const index = allMachines.findIndex(m => m.nev === document.getElementById("edit-machine-name").value);
      const oldTerulet = allMachines[index].terulet;
      const newTerulet = document.getElementById("edit-machine-terulet").value;
      const newName = document.getElementById("edit-machine-name").value;
      const newBelsoszam = document.getElementById("edit-machine-belsoszam").value;
      const newKoltseghely = document.getElementById("edit-machine-koltseghely").value;

      // Gépet eltávolítjuk az eredeti területről
      gepek[oldTerulet] = gepek[oldTerulet].filter(gep => gep !== newName);
      // Gépet hozzáadjuk az új területről, ha még nem létezik
      if (!gepek[newTerulet].includes(newName)) gepek[newTerulet].push(newName);

      // Adatok frissítése
      gepekAdatok[newName] = {
        belsoMegrendelesiSzam: newBelsoszam || "",
        koltseghely: newKoltseghely || ""
      };

      saveGepek();
      document.getElementById("edit-machine-popup").style.display = "none";
      document.getElementById("edit-machine-name").value = "";
      document.getElementById("edit-machine-belsoszam").value = "";
      document.getElementById("edit-machine-koltseghely").value = "";
    }

    document.getElementById("add-machine-btn").addEventListener("click", () => {
      document.getElementById("edit-machine-name").value = "";
      document.getElementById("edit-machine-terulet").value = "MFC-terület";
      document.getElementById("edit-machine-belsoszam").value = "";
      document.getElementById("edit-machine-koltseghely").value = "";
      document.getElementById("edit-machine-popup").style.display = "block";
    });

    // Lista inicializálása betöltéskor
    window.onload = function() {
      updateFoglalasLista();
      updateMachineLista();
      updateMachineDropdown();
    };
  </script>

</body>
</html>
